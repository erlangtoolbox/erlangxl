%define realname erlangxl
Summary:        ErlangXL
Name:           strikead-erlangxl
Version:        {{VERSION}}
License:        Erlang Public License
Release:        1
Requires:       erlang yaws erlang-flake erlang-erleveldb strikead-erlang-ktuo strikead-erlang-erlandox
Conflicts:	strikead-erlang-commons
BuildRequires:  erlang yaws
# it actually also build-requires strikead-erlang-erlandox; since
# jenkins is not likely to have it, there is a workaround in
# Makefile.inc (the parse_transorm.beam will be looked for in
# $BUILDROOT/lib, where it will be deposited by a previous run of
# ebt). For building it standalone, just install
# strikead-erlang-erlando.
Group:          StrikeAd/Software
Source:         %{realname}-%{version}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-root

%define erl_lib_root /usr/%{_lib}/erlang/lib

%description
ErlangXL Library

%prep
%setup -n %{realname}-%{version}

%build
make $MAKEOPTS

%install

common_vsn=`./version.sh`

apps="xl_stdlib \
	xl_json \
	xl_leveldb \
	xl_yaws \
	xl_csv \
	xl_io \
	xl_net \
	persist"

function install_app
{
    subapp="$1-%{version}"
    absappdir=%{buildroot}/%{erl_lib_root}/$subapp
    mkdir -p $absappdir/ebin
    cp $1/ebin/*.beam $absappdir/ebin
    ## just in this project .app files happen to reside in src/
    [ -r $1/src/$1.app ] && \
	cp $1/src/$1.app $absappdir/ebin

    if [ -d $1/include ]; then
	mkdir -p $absappdir/include
	cp $1/include/*.hrl $absappdir/include
    fi

    ## take care of subdirs
    if [ -d $1/priv ]; then
	mkdir -p $absappdir/priv
	(cd $1; cp -a --parent priv $absappdir)
    fi
}

for app in $apps; do
    install_app $app
done

%Clean
%{__rm} -rf %{buildroot}

%files
%defattr(-,root,root)
%{erl_lib_root}

%changelog
* Fri Aug 31 2012 andrei.zavada@strikead.com
- Workaround for erlandox build-requirement
* Mon Aug 20 2012 andrei.zavada@strikead.com
- Look for .app files in */src/
- Install any subdirs in */priv/
- Mark whole dir in %files
* Fri Aug 17 2012 andrei.zavada@strikead.com
- Use version.sh
* Mon Aug 13 2012 andrei.zavada@strikead.com
- Separate installs of individual applications
- Move erlando and ktuo to BuildDepends
* Tue Aug  7 2012 andrei.zavada@strikead.com
- Initial package for OpenSUSE
